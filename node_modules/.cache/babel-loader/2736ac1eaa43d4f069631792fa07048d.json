{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer;\n\nvar BN = require('./bn');\n\nvar ECJPoint = require('./ecjpoint');\n\nfunction ECPoint(x, y) {\n  if (x === null && y === null) {\n    this.x = this.y = null;\n    this.inf = true;\n  } else {\n    this.x = x;\n    this.y = y;\n    this.inf = false;\n  }\n}\n\nECPoint.fromPublicKey = function (publicKey) {\n  var first = publicKey[0];\n  var x;\n  var y;\n\n  if (publicKey.length === 33 && (first === 0x02 || first === 0x03)) {\n    x = BN.fromBuffer(publicKey.slice(1, 33)); // overflow\n\n    if (x.ucmp(BN.p) >= 0) return null; // create from X\n\n    y = x.redSqr().redMul(x).redIAdd7().redSqrt();\n    if (y === null) return null;\n    if (first === 0x03 !== y.isOdd()) y = y.redNeg();\n    return new ECPoint(x, y);\n  }\n\n  if (publicKey.length === 65 && (first === 0x04 || first === 0x06 || first === 0x07)) {\n    x = BN.fromBuffer(publicKey.slice(1, 33));\n    y = BN.fromBuffer(publicKey.slice(33, 65)); // overflow\n\n    if (x.ucmp(BN.p) >= 0 || y.ucmp(BN.p) >= 0) return null; // is odd flag\n\n    if ((first === 0x06 || first === 0x07) && y.isOdd() !== (first === 0x07)) return null; // x*x*x + 7 = y*y\n\n    if (x.redSqr().redMul(x).redIAdd7().ucmp(y.redSqr()) !== 0) return null;\n    return new ECPoint(x, y);\n  }\n\n  return null;\n};\n\nECPoint.prototype.toPublicKey = function (compressed) {\n  var x = this.x;\n  var y = this.y;\n  var publicKey;\n\n  if (compressed) {\n    publicKey = Buffer.alloc(33);\n    publicKey[0] = y.isOdd() ? 0x03 : 0x02;\n    x.toBuffer().copy(publicKey, 1);\n  } else {\n    publicKey = Buffer.alloc(65);\n    publicKey[0] = 0x04;\n    x.toBuffer().copy(publicKey, 1);\n    y.toBuffer().copy(publicKey, 33);\n  }\n\n  return publicKey;\n};\n\nECPoint.fromECJPoint = function (p) {\n  if (p.inf) return new ECPoint(null, null);\n  var zinv = p.z.redInvm();\n  var zinv2 = zinv.redSqr();\n  var ax = p.x.redMul(zinv2);\n  var ay = p.y.redMul(zinv2).redMul(zinv);\n  return new ECPoint(ax, ay);\n};\n\nECPoint.prototype.toECJPoint = function () {\n  if (this.inf) return new ECJPoint(null, null, null);\n  return new ECJPoint(this.x, this.y, ECJPoint.one);\n};\n\nECPoint.prototype.neg = function () {\n  if (this.inf) return this;\n  return new ECPoint(this.x, this.y.redNeg());\n};\n\nECPoint.prototype.add = function (p) {\n  // O + P = P\n  if (this.inf) return p; // P + O = P\n\n  if (p.inf) return this;\n\n  if (this.x.ucmp(p.x) === 0) {\n    // P + P = 2P\n    if (this.y.ucmp(p.y) === 0) return this.dbl(); // P + (-P) = O\n\n    return new ECPoint(null, null);\n  } // s = (y - yp) / (x - xp)\n  // nx = s^2 - x - xp\n  // ny = s * (x - nx) - y\n\n\n  var s = this.y.redSub(p.y);\n  if (!s.isZero()) s = s.redMul(this.x.redSub(p.x).redInvm());\n  var nx = s.redSqr().redISub(this.x).redISub(p.x);\n  var ny = s.redMul(this.x.redSub(nx)).redISub(this.y);\n  return new ECPoint(nx, ny);\n};\n\nECPoint.prototype.dbl = function () {\n  if (this.inf) return this; // 2P = O\n\n  var yy = this.y.redAdd(this.y);\n  if (yy.isZero()) return new ECPoint(null, null); // s = (3 * x^2) / (2 * y)\n  // nx = s^2 - 2*x\n  // ny = s * (x - nx) - y\n\n  var x2 = this.x.redSqr();\n  var s = x2.redAdd(x2).redIAdd(x2).redMul(yy.redInvm());\n  var nx = s.redSqr().redISub(this.x.redAdd(this.x));\n  var ny = s.redMul(this.x.redSub(nx)).redISub(this.y);\n  return new ECPoint(nx, ny);\n};\n\nECPoint.prototype.mul = function (num) {\n  // Algorithm 3.36 Window NAF method for point multiplication\n  var nafPoints = this._getNAFPoints(4);\n\n  var points = nafPoints.points; // Get NAF form\n\n  var naf = num.getNAF(nafPoints.wnd); // Add `this`*(N+1) for every w-NAF index\n\n  var acc = new ECJPoint(null, null, null);\n\n  for (var i = naf.length - 1; i >= 0; i--) {\n    // Count zeroes\n    for (var k = 0; i >= 0 && naf[i] === 0; i--, ++k) {\n      ;\n    }\n\n    if (i >= 0) k += 1;\n    acc = acc.dblp(k);\n    if (i < 0) break; // J +- P\n\n    var z = naf[i];\n\n    if (z > 0) {\n      acc = acc.mixedAdd(points[z - 1 >> 1]);\n    } else {\n      acc = acc.mixedAdd(points[-z - 1 >> 1].neg());\n    }\n  }\n\n  return ECPoint.fromECJPoint(acc);\n};\n\nECPoint.prototype._getNAFPoints1 = function () {\n  return {\n    wnd: 1,\n    points: [this]\n  };\n};\n\nECPoint.prototype._getNAFPoints = function (wnd) {\n  var points = new Array((1 << wnd) - 1);\n  points[0] = this;\n  var dbl = this.dbl();\n\n  for (var i = 1; i < points.length; ++i) {\n    points[i] = points[i - 1].add(dbl);\n  }\n\n  return {\n    wnd: wnd,\n    points: points\n  };\n};\n\nmodule.exports = ECPoint;","map":{"version":3,"sources":["C:/Users/anshm/blockdrive/node_modules/libp2p-crypto-secp256k1/node_modules/secp256k1/lib/js/ecpoint.js"],"names":["Buffer","require","BN","ECJPoint","ECPoint","x","y","inf","fromPublicKey","publicKey","first","length","fromBuffer","slice","ucmp","p","redSqr","redMul","redIAdd7","redSqrt","isOdd","redNeg","prototype","toPublicKey","compressed","alloc","toBuffer","copy","fromECJPoint","zinv","z","redInvm","zinv2","ax","ay","toECJPoint","one","neg","add","dbl","s","redSub","isZero","nx","redISub","ny","yy","redAdd","x2","redIAdd","mul","num","nafPoints","_getNAFPoints","points","naf","getNAF","wnd","acc","i","k","dblp","mixedAdd","_getNAFPoints1","Array","module","exports"],"mappings":"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","sourcesContent":["'use strict'\nvar Buffer = require('safe-buffer').Buffer\nvar BN = require('./bn')\nvar ECJPoint = require('./ecjpoint')\n\nfunction ECPoint (x, y) {\n  if (x === null && y === null) {\n    this.x = this.y = null\n    this.inf = true\n  } else {\n    this.x = x\n    this.y = y\n    this.inf = false\n  }\n}\n\nECPoint.fromPublicKey = function (publicKey) {\n  var first = publicKey[0]\n  var x\n  var y\n\n  if (publicKey.length === 33 && (first === 0x02 || first === 0x03)) {\n    x = BN.fromBuffer(publicKey.slice(1, 33))\n\n    // overflow\n    if (x.ucmp(BN.p) >= 0) return null\n\n    // create from X\n    y = x.redSqr().redMul(x).redIAdd7().redSqrt()\n    if (y === null) return null\n    if ((first === 0x03) !== y.isOdd()) y = y.redNeg()\n\n    return new ECPoint(x, y)\n  }\n\n  if (publicKey.length === 65 && (first === 0x04 || first === 0x06 || first === 0x07)) {\n    x = BN.fromBuffer(publicKey.slice(1, 33))\n    y = BN.fromBuffer(publicKey.slice(33, 65))\n\n    // overflow\n    if (x.ucmp(BN.p) >= 0 || y.ucmp(BN.p) >= 0) return null\n\n    // is odd flag\n    if ((first === 0x06 || first === 0x07) && y.isOdd() !== (first === 0x07)) return null\n\n    // x*x*x + 7 = y*y\n    if (x.redSqr().redMul(x).redIAdd7().ucmp(y.redSqr()) !== 0) return null\n\n    return new ECPoint(x, y)\n  }\n\n  return null\n}\n\nECPoint.prototype.toPublicKey = function (compressed) {\n  var x = this.x\n  var y = this.y\n  var publicKey\n\n  if (compressed) {\n    publicKey = Buffer.alloc(33)\n    publicKey[0] = y.isOdd() ? 0x03 : 0x02\n    x.toBuffer().copy(publicKey, 1)\n  } else {\n    publicKey = Buffer.alloc(65)\n    publicKey[0] = 0x04\n    x.toBuffer().copy(publicKey, 1)\n    y.toBuffer().copy(publicKey, 33)\n  }\n\n  return publicKey\n}\n\nECPoint.fromECJPoint = function (p) {\n  if (p.inf) return new ECPoint(null, null)\n\n  var zinv = p.z.redInvm()\n  var zinv2 = zinv.redSqr()\n  var ax = p.x.redMul(zinv2)\n  var ay = p.y.redMul(zinv2).redMul(zinv)\n\n  return new ECPoint(ax, ay)\n}\n\nECPoint.prototype.toECJPoint = function () {\n  if (this.inf) return new ECJPoint(null, null, null)\n\n  return new ECJPoint(this.x, this.y, ECJPoint.one)\n}\n\nECPoint.prototype.neg = function () {\n  if (this.inf) return this\n\n  return new ECPoint(this.x, this.y.redNeg())\n}\n\nECPoint.prototype.add = function (p) {\n  // O + P = P\n  if (this.inf) return p\n\n  // P + O = P\n  if (p.inf) return this\n\n  if (this.x.ucmp(p.x) === 0) {\n    // P + P = 2P\n    if (this.y.ucmp(p.y) === 0) return this.dbl()\n    // P + (-P) = O\n    return new ECPoint(null, null)\n  }\n\n  // s = (y - yp) / (x - xp)\n  // nx = s^2 - x - xp\n  // ny = s * (x - nx) - y\n  var s = this.y.redSub(p.y)\n  if (!s.isZero()) s = s.redMul(this.x.redSub(p.x).redInvm())\n\n  var nx = s.redSqr().redISub(this.x).redISub(p.x)\n  var ny = s.redMul(this.x.redSub(nx)).redISub(this.y)\n  return new ECPoint(nx, ny)\n}\n\nECPoint.prototype.dbl = function () {\n  if (this.inf) return this\n\n  // 2P = O\n  var yy = this.y.redAdd(this.y)\n  if (yy.isZero()) return new ECPoint(null, null)\n\n  // s = (3 * x^2) / (2 * y)\n  // nx = s^2 - 2*x\n  // ny = s * (x - nx) - y\n  var x2 = this.x.redSqr()\n  var s = x2.redAdd(x2).redIAdd(x2).redMul(yy.redInvm())\n\n  var nx = s.redSqr().redISub(this.x.redAdd(this.x))\n  var ny = s.redMul(this.x.redSub(nx)).redISub(this.y)\n  return new ECPoint(nx, ny)\n}\n\nECPoint.prototype.mul = function (num) {\n  // Algorithm 3.36 Window NAF method for point multiplication\n  var nafPoints = this._getNAFPoints(4)\n  var points = nafPoints.points\n\n  // Get NAF form\n  var naf = num.getNAF(nafPoints.wnd)\n\n  // Add `this`*(N+1) for every w-NAF index\n  var acc = new ECJPoint(null, null, null)\n  for (var i = naf.length - 1; i >= 0; i--) {\n    // Count zeroes\n    for (var k = 0; i >= 0 && naf[i] === 0; i--, ++k);\n    if (i >= 0) k += 1\n    acc = acc.dblp(k)\n\n    if (i < 0) break\n\n    // J +- P\n    var z = naf[i]\n    if (z > 0) {\n      acc = acc.mixedAdd(points[(z - 1) >> 1])\n    } else {\n      acc = acc.mixedAdd(points[(-z - 1) >> 1].neg())\n    }\n  }\n\n  return ECPoint.fromECJPoint(acc)\n}\n\nECPoint.prototype._getNAFPoints1 = function () {\n  return { wnd: 1, points: [this] }\n}\n\nECPoint.prototype._getNAFPoints = function (wnd) {\n  var points = new Array((1 << wnd) - 1)\n  points[0] = this\n  var dbl = this.dbl()\n  for (var i = 1; i < points.length; ++i) points[i] = points[i - 1].add(dbl)\n  return { wnd: wnd, points: points }\n}\n\nmodule.exports = ECPoint\n"]},"metadata":{},"sourceType":"script"}
{"ast":null,"code":"var constants = require('fs-constants');\n\nvar eos = require('end-of-stream');\n\nvar inherits = require('inherits');\n\nvar alloc = Buffer.alloc;\n\nvar Readable = require('readable-stream').Readable;\n\nvar Writable = require('readable-stream').Writable;\n\nvar StringDecoder = require('string_decoder').StringDecoder;\n\nvar headers = require('./headers');\n\nvar DMODE = parseInt('755', 8);\nvar FMODE = parseInt('644', 8);\nvar END_OF_TAR = alloc(1024);\n\nvar noop = function noop() {};\n\nvar overflow = function overflow(self, size) {\n  size &= 511;\n  if (size) self.push(END_OF_TAR.slice(0, 512 - size));\n};\n\nfunction modeToType(mode) {\n  switch (mode & constants.S_IFMT) {\n    case constants.S_IFBLK:\n      return 'block-device';\n\n    case constants.S_IFCHR:\n      return 'character-device';\n\n    case constants.S_IFDIR:\n      return 'directory';\n\n    case constants.S_IFIFO:\n      return 'fifo';\n\n    case constants.S_IFLNK:\n      return 'symlink';\n  }\n\n  return 'file';\n}\n\nvar Sink = function Sink(to) {\n  Writable.call(this);\n  this.written = 0;\n  this._to = to;\n  this._destroyed = false;\n};\n\ninherits(Sink, Writable);\n\nSink.prototype._write = function (data, enc, cb) {\n  this.written += data.length;\n  if (this._to.push(data)) return cb();\n  this._to._drain = cb;\n};\n\nSink.prototype.destroy = function () {\n  if (this._destroyed) return;\n  this._destroyed = true;\n  this.emit('close');\n};\n\nvar LinkSink = function LinkSink() {\n  Writable.call(this);\n  this.linkname = '';\n  this._decoder = new StringDecoder('utf-8');\n  this._destroyed = false;\n};\n\ninherits(LinkSink, Writable);\n\nLinkSink.prototype._write = function (data, enc, cb) {\n  this.linkname += this._decoder.write(data);\n  cb();\n};\n\nLinkSink.prototype.destroy = function () {\n  if (this._destroyed) return;\n  this._destroyed = true;\n  this.emit('close');\n};\n\nvar Void = function Void() {\n  Writable.call(this);\n  this._destroyed = false;\n};\n\ninherits(Void, Writable);\n\nVoid.prototype._write = function (data, enc, cb) {\n  cb(new Error('No body allowed for this entry'));\n};\n\nVoid.prototype.destroy = function () {\n  if (this._destroyed) return;\n  this._destroyed = true;\n  this.emit('close');\n};\n\nvar Pack = function Pack(opts) {\n  if (!(this instanceof Pack)) return new Pack(opts);\n  Readable.call(this, opts);\n  this._drain = noop;\n  this._finalized = false;\n  this._finalizing = false;\n  this._destroyed = false;\n  this._stream = null;\n};\n\ninherits(Pack, Readable);\n\nPack.prototype.entry = function (header, buffer, callback) {\n  if (this._stream) throw new Error('already piping an entry');\n  if (this._finalized || this._destroyed) return;\n\n  if (typeof buffer === 'function') {\n    callback = buffer;\n    buffer = null;\n  }\n\n  if (!callback) callback = noop;\n  var self = this;\n  if (!header.size || header.type === 'symlink') header.size = 0;\n  if (!header.type) header.type = modeToType(header.mode);\n  if (!header.mode) header.mode = header.type === 'directory' ? DMODE : FMODE;\n  if (!header.uid) header.uid = 0;\n  if (!header.gid) header.gid = 0;\n  if (!header.mtime) header.mtime = new Date();\n  if (typeof buffer === 'string') buffer = Buffer.from(buffer);\n\n  if (Buffer.isBuffer(buffer)) {\n    header.size = buffer.length;\n\n    this._encode(header);\n\n    var ok = this.push(buffer);\n    overflow(self, header.size);\n    if (ok) process.nextTick(callback);else this._drain = callback;\n    return new Void();\n  }\n\n  if (header.type === 'symlink' && !header.linkname) {\n    var linkSink = new LinkSink();\n    eos(linkSink, function (err) {\n      if (err) {\n        // stream was closed\n        self.destroy();\n        return callback(err);\n      }\n\n      header.linkname = linkSink.linkname;\n\n      self._encode(header);\n\n      callback();\n    });\n    return linkSink;\n  }\n\n  this._encode(header);\n\n  if (header.type !== 'file' && header.type !== 'contiguous-file') {\n    process.nextTick(callback);\n    return new Void();\n  }\n\n  var sink = new Sink(this);\n  this._stream = sink;\n  eos(sink, function (err) {\n    self._stream = null;\n\n    if (err) {\n      // stream was closed\n      self.destroy();\n      return callback(err);\n    }\n\n    if (sink.written !== header.size) {\n      // corrupting tar\n      self.destroy();\n      return callback(new Error('size mismatch'));\n    }\n\n    overflow(self, header.size);\n    if (self._finalizing) self.finalize();\n    callback();\n  });\n  return sink;\n};\n\nPack.prototype.finalize = function () {\n  if (this._stream) {\n    this._finalizing = true;\n    return;\n  }\n\n  if (this._finalized) return;\n  this._finalized = true;\n  this.push(END_OF_TAR);\n  this.push(null);\n};\n\nPack.prototype.destroy = function (err) {\n  if (this._destroyed) return;\n  this._destroyed = true;\n  if (err) this.emit('error', err);\n  this.emit('close');\n  if (this._stream && this._stream.destroy) this._stream.destroy();\n};\n\nPack.prototype._encode = function (header) {\n  if (!header.pax) {\n    var buf = headers.encode(header);\n\n    if (buf) {\n      this.push(buf);\n      return;\n    }\n  }\n\n  this._encodePax(header);\n};\n\nPack.prototype._encodePax = function (header) {\n  var paxHeader = headers.encodePax({\n    name: header.name,\n    linkname: header.linkname,\n    pax: header.pax\n  });\n  var newHeader = {\n    name: 'PaxHeader',\n    mode: header.mode,\n    uid: header.uid,\n    gid: header.gid,\n    size: paxHeader.length,\n    mtime: header.mtime,\n    type: 'pax-header',\n    linkname: header.linkname && 'PaxHeader',\n    uname: header.uname,\n    gname: header.gname,\n    devmajor: header.devmajor,\n    devminor: header.devminor\n  };\n  this.push(headers.encode(newHeader));\n  this.push(paxHeader);\n  overflow(this, paxHeader.length);\n  newHeader.size = header.size;\n  newHeader.type = header.type;\n  this.push(headers.encode(newHeader));\n};\n\nPack.prototype._read = function (n) {\n  var drain = this._drain;\n  this._drain = noop;\n  drain();\n};\n\nmodule.exports = Pack;","map":{"version":3,"sources":["C:/Users/anshm/blockdrive/node_modules/tar-stream/pack.js"],"names":["constants","require","eos","inherits","alloc","Buffer","Readable","Writable","StringDecoder","headers","DMODE","parseInt","FMODE","END_OF_TAR","noop","overflow","self","size","push","slice","modeToType","mode","S_IFMT","S_IFBLK","S_IFCHR","S_IFDIR","S_IFIFO","S_IFLNK","Sink","to","call","written","_to","_destroyed","prototype","_write","data","enc","cb","length","_drain","destroy","emit","LinkSink","linkname","_decoder","write","Void","Error","Pack","opts","_finalized","_finalizing","_stream","entry","header","buffer","callback","type","uid","gid","mtime","Date","from","isBuffer","_encode","ok","process","nextTick","linkSink","err","sink","finalize","pax","buf","encode","_encodePax","paxHeader","encodePax","name","newHeader","uname","gname","devmajor","devminor","_read","n","drain","module","exports"],"mappings":"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","sourcesContent":["var constants = require('fs-constants')\nvar eos = require('end-of-stream')\nvar inherits = require('inherits')\nvar alloc = Buffer.alloc\n\nvar Readable = require('readable-stream').Readable\nvar Writable = require('readable-stream').Writable\nvar StringDecoder = require('string_decoder').StringDecoder\n\nvar headers = require('./headers')\n\nvar DMODE = parseInt('755', 8)\nvar FMODE = parseInt('644', 8)\n\nvar END_OF_TAR = alloc(1024)\n\nvar noop = function () {}\n\nvar overflow = function (self, size) {\n  size &= 511\n  if (size) self.push(END_OF_TAR.slice(0, 512 - size))\n}\n\nfunction modeToType (mode) {\n  switch (mode & constants.S_IFMT) {\n    case constants.S_IFBLK: return 'block-device'\n    case constants.S_IFCHR: return 'character-device'\n    case constants.S_IFDIR: return 'directory'\n    case constants.S_IFIFO: return 'fifo'\n    case constants.S_IFLNK: return 'symlink'\n  }\n\n  return 'file'\n}\n\nvar Sink = function (to) {\n  Writable.call(this)\n  this.written = 0\n  this._to = to\n  this._destroyed = false\n}\n\ninherits(Sink, Writable)\n\nSink.prototype._write = function (data, enc, cb) {\n  this.written += data.length\n  if (this._to.push(data)) return cb()\n  this._to._drain = cb\n}\n\nSink.prototype.destroy = function () {\n  if (this._destroyed) return\n  this._destroyed = true\n  this.emit('close')\n}\n\nvar LinkSink = function () {\n  Writable.call(this)\n  this.linkname = ''\n  this._decoder = new StringDecoder('utf-8')\n  this._destroyed = false\n}\n\ninherits(LinkSink, Writable)\n\nLinkSink.prototype._write = function (data, enc, cb) {\n  this.linkname += this._decoder.write(data)\n  cb()\n}\n\nLinkSink.prototype.destroy = function () {\n  if (this._destroyed) return\n  this._destroyed = true\n  this.emit('close')\n}\n\nvar Void = function () {\n  Writable.call(this)\n  this._destroyed = false\n}\n\ninherits(Void, Writable)\n\nVoid.prototype._write = function (data, enc, cb) {\n  cb(new Error('No body allowed for this entry'))\n}\n\nVoid.prototype.destroy = function () {\n  if (this._destroyed) return\n  this._destroyed = true\n  this.emit('close')\n}\n\nvar Pack = function (opts) {\n  if (!(this instanceof Pack)) return new Pack(opts)\n  Readable.call(this, opts)\n\n  this._drain = noop\n  this._finalized = false\n  this._finalizing = false\n  this._destroyed = false\n  this._stream = null\n}\n\ninherits(Pack, Readable)\n\nPack.prototype.entry = function (header, buffer, callback) {\n  if (this._stream) throw new Error('already piping an entry')\n  if (this._finalized || this._destroyed) return\n\n  if (typeof buffer === 'function') {\n    callback = buffer\n    buffer = null\n  }\n\n  if (!callback) callback = noop\n\n  var self = this\n\n  if (!header.size || header.type === 'symlink') header.size = 0\n  if (!header.type) header.type = modeToType(header.mode)\n  if (!header.mode) header.mode = header.type === 'directory' ? DMODE : FMODE\n  if (!header.uid) header.uid = 0\n  if (!header.gid) header.gid = 0\n  if (!header.mtime) header.mtime = new Date()\n\n  if (typeof buffer === 'string') buffer = Buffer.from(buffer)\n  if (Buffer.isBuffer(buffer)) {\n    header.size = buffer.length\n    this._encode(header)\n    var ok = this.push(buffer)\n    overflow(self, header.size)\n    if (ok) process.nextTick(callback)\n    else this._drain = callback\n    return new Void()\n  }\n\n  if (header.type === 'symlink' && !header.linkname) {\n    var linkSink = new LinkSink()\n    eos(linkSink, function (err) {\n      if (err) { // stream was closed\n        self.destroy()\n        return callback(err)\n      }\n\n      header.linkname = linkSink.linkname\n      self._encode(header)\n      callback()\n    })\n\n    return linkSink\n  }\n\n  this._encode(header)\n\n  if (header.type !== 'file' && header.type !== 'contiguous-file') {\n    process.nextTick(callback)\n    return new Void()\n  }\n\n  var sink = new Sink(this)\n\n  this._stream = sink\n\n  eos(sink, function (err) {\n    self._stream = null\n\n    if (err) { // stream was closed\n      self.destroy()\n      return callback(err)\n    }\n\n    if (sink.written !== header.size) { // corrupting tar\n      self.destroy()\n      return callback(new Error('size mismatch'))\n    }\n\n    overflow(self, header.size)\n    if (self._finalizing) self.finalize()\n    callback()\n  })\n\n  return sink\n}\n\nPack.prototype.finalize = function () {\n  if (this._stream) {\n    this._finalizing = true\n    return\n  }\n\n  if (this._finalized) return\n  this._finalized = true\n  this.push(END_OF_TAR)\n  this.push(null)\n}\n\nPack.prototype.destroy = function (err) {\n  if (this._destroyed) return\n  this._destroyed = true\n\n  if (err) this.emit('error', err)\n  this.emit('close')\n  if (this._stream && this._stream.destroy) this._stream.destroy()\n}\n\nPack.prototype._encode = function (header) {\n  if (!header.pax) {\n    var buf = headers.encode(header)\n    if (buf) {\n      this.push(buf)\n      return\n    }\n  }\n  this._encodePax(header)\n}\n\nPack.prototype._encodePax = function (header) {\n  var paxHeader = headers.encodePax({\n    name: header.name,\n    linkname: header.linkname,\n    pax: header.pax\n  })\n\n  var newHeader = {\n    name: 'PaxHeader',\n    mode: header.mode,\n    uid: header.uid,\n    gid: header.gid,\n    size: paxHeader.length,\n    mtime: header.mtime,\n    type: 'pax-header',\n    linkname: header.linkname && 'PaxHeader',\n    uname: header.uname,\n    gname: header.gname,\n    devmajor: header.devmajor,\n    devminor: header.devminor\n  }\n\n  this.push(headers.encode(newHeader))\n  this.push(paxHeader)\n  overflow(this, paxHeader.length)\n\n  newHeader.size = header.size\n  newHeader.type = header.type\n  this.push(headers.encode(newHeader))\n}\n\nPack.prototype._read = function (n) {\n  var drain = this._drain\n  this._drain = noop\n  drain()\n}\n\nmodule.exports = Pack\n"]},"metadata":{},"sourceType":"script"}
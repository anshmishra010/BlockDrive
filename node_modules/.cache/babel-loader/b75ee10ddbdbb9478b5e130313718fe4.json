{"ast":null,"code":"'use strict';\n\nvar nodeify = require('../nodeify');\n\nvar webcrypto = require('../webcrypto');\n\nvar randomBytes = require('../random-bytes');\n\nexports.utils = require('./rsa-utils');\n\nexports.generateKey = function (bits, callback) {\n  nodeify(webcrypto.subtle.generateKey({\n    name: 'RSASSA-PKCS1-v1_5',\n    modulusLength: bits,\n    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),\n    hash: {\n      name: 'SHA-256'\n    }\n  }, true, ['sign', 'verify']).then(exportKey).then(function (keys) {\n    return {\n      privateKey: keys[0],\n      publicKey: keys[1]\n    };\n  }), callback);\n}; // Takes a jwk key\n\n\nexports.unmarshalPrivateKey = function (key, callback) {\n  var privateKey = webcrypto.subtle.importKey('jwk', key, {\n    name: 'RSASSA-PKCS1-v1_5',\n    hash: {\n      name: 'SHA-256'\n    }\n  }, true, ['sign']);\n  nodeify(Promise.all([privateKey, derivePublicFromPrivate(key)]).then(function (keys) {\n    return exportKey({\n      privateKey: keys[0],\n      publicKey: keys[1]\n    });\n  }).then(function (keys) {\n    return {\n      privateKey: keys[0],\n      publicKey: keys[1]\n    };\n  }), callback);\n};\n\nexports.getRandomValues = randomBytes;\n\nexports.hashAndSign = function (key, msg, callback) {\n  nodeify(webcrypto.subtle.importKey('jwk', key, {\n    name: 'RSASSA-PKCS1-v1_5',\n    hash: {\n      name: 'SHA-256'\n    }\n  }, false, ['sign']).then(function (privateKey) {\n    return webcrypto.subtle.sign({\n      name: 'RSASSA-PKCS1-v1_5'\n    }, privateKey, Uint8Array.from(msg));\n  }).then(function (sig) {\n    return Buffer.from(sig);\n  }), callback);\n};\n\nexports.hashAndVerify = function (key, sig, msg, callback) {\n  nodeify(webcrypto.subtle.importKey('jwk', key, {\n    name: 'RSASSA-PKCS1-v1_5',\n    hash: {\n      name: 'SHA-256'\n    }\n  }, false, ['verify']).then(function (publicKey) {\n    return webcrypto.subtle.verify({\n      name: 'RSASSA-PKCS1-v1_5'\n    }, publicKey, sig, msg);\n  }), callback);\n};\n\nfunction exportKey(pair) {\n  return Promise.all([webcrypto.subtle.exportKey('jwk', pair.privateKey), webcrypto.subtle.exportKey('jwk', pair.publicKey)]);\n}\n\nfunction derivePublicFromPrivate(jwKey) {\n  return webcrypto.subtle.importKey('jwk', {\n    kty: jwKey.kty,\n    n: jwKey.n,\n    e: jwKey.e\n  }, {\n    name: 'RSASSA-PKCS1-v1_5',\n    hash: {\n      name: 'SHA-256'\n    }\n  }, true, ['verify']);\n}\n/*\n\nRSA encryption/decryption for the browser with webcrypto workarround\n\"bloody dark magic. webcrypto's why.\"\n\nExplanation:\n  - Convert JWK to nodeForge\n  - Convert msg buffer to nodeForge buffer: ByteBuffer is a \"binary-string backed buffer\", so let's make our buffer a binary string\n  - Convert resulting nodeForge buffer to buffer: it returns a binary string, turn that into a uint8array(buffer)\n\n*/\n\n\nvar _require = require('./jwk2pem'),\n    jwk2pub = _require.jwk2pub,\n    jwk2priv = _require.jwk2priv;\n\nfunction convertKey(key, pub, msg, handle) {\n  var fkey = pub ? jwk2pub(key) : jwk2priv(key);\n  var fmsg = Buffer.from(msg).toString('binary');\n  var fomsg = handle(fmsg, fkey);\n  return Buffer.from(fomsg, 'binary');\n}\n\nexports.encrypt = function (key, msg) {\n  return convertKey(key, true, msg, function (msg, key) {\n    return key.encrypt(msg);\n  });\n};\n\nexports.decrypt = function (key, msg) {\n  return convertKey(key, false, msg, function (msg, key) {\n    return key.decrypt(msg);\n  });\n};","map":{"version":3,"sources":["C:/Users/anshm/blockdrive/node_modules/libp2p-crypto/src/keys/rsa-browser.js"],"names":["nodeify","require","webcrypto","randomBytes","exports","utils","generateKey","bits","callback","subtle","name","modulusLength","publicExponent","Uint8Array","hash","then","exportKey","keys","privateKey","publicKey","unmarshalPrivateKey","key","importKey","Promise","all","derivePublicFromPrivate","getRandomValues","hashAndSign","msg","sign","from","sig","Buffer","hashAndVerify","verify","pair","jwKey","kty","n","e","jwk2pub","jwk2priv","convertKey","pub","handle","fkey","fmsg","toString","fomsg","encrypt","decrypt"],"mappings":"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","sourcesContent":["'use strict'\n\nconst nodeify = require('../nodeify')\nconst webcrypto = require('../webcrypto')\nconst randomBytes = require('../random-bytes')\n\nexports.utils = require('./rsa-utils')\n\nexports.generateKey = function (bits, callback) {\n  nodeify(webcrypto.subtle.generateKey(\n    {\n      name: 'RSASSA-PKCS1-v1_5',\n      modulusLength: bits,\n      publicExponent: new Uint8Array([0x01, 0x00, 0x01]),\n      hash: { name: 'SHA-256' }\n    },\n    true,\n    ['sign', 'verify']\n  )\n    .then(exportKey)\n    .then((keys) => ({\n      privateKey: keys[0],\n      publicKey: keys[1]\n    })), callback)\n}\n\n// Takes a jwk key\nexports.unmarshalPrivateKey = function (key, callback) {\n  const privateKey = webcrypto.subtle.importKey(\n    'jwk',\n    key,\n    {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: { name: 'SHA-256' }\n    },\n    true,\n    ['sign']\n  )\n\n  nodeify(Promise.all([\n    privateKey,\n    derivePublicFromPrivate(key)\n  ]).then((keys) => exportKey({\n    privateKey: keys[0],\n    publicKey: keys[1]\n  })).then((keys) => ({\n    privateKey: keys[0],\n    publicKey: keys[1]\n  })), callback)\n}\n\nexports.getRandomValues = randomBytes\n\nexports.hashAndSign = function (key, msg, callback) {\n  nodeify(webcrypto.subtle.importKey(\n    'jwk',\n    key,\n    {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: { name: 'SHA-256' }\n    },\n    false,\n    ['sign']\n  ).then((privateKey) => {\n    return webcrypto.subtle.sign(\n      { name: 'RSASSA-PKCS1-v1_5' },\n      privateKey,\n      Uint8Array.from(msg)\n    )\n  }).then((sig) => Buffer.from(sig)), callback)\n}\n\nexports.hashAndVerify = function (key, sig, msg, callback) {\n  nodeify(webcrypto.subtle.importKey(\n    'jwk',\n    key,\n    {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: { name: 'SHA-256' }\n    },\n    false,\n    ['verify']\n  ).then((publicKey) => {\n    return webcrypto.subtle.verify(\n      { name: 'RSASSA-PKCS1-v1_5' },\n      publicKey,\n      sig,\n      msg\n    )\n  }), callback)\n}\n\nfunction exportKey (pair) {\n  return Promise.all([\n    webcrypto.subtle.exportKey('jwk', pair.privateKey),\n    webcrypto.subtle.exportKey('jwk', pair.publicKey)\n  ])\n}\n\nfunction derivePublicFromPrivate (jwKey) {\n  return webcrypto.subtle.importKey(\n    'jwk',\n    {\n      kty: jwKey.kty,\n      n: jwKey.n,\n      e: jwKey.e\n    },\n    {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: { name: 'SHA-256' }\n    },\n    true,\n    ['verify']\n  )\n}\n\n/*\n\nRSA encryption/decryption for the browser with webcrypto workarround\n\"bloody dark magic. webcrypto's why.\"\n\nExplanation:\n  - Convert JWK to nodeForge\n  - Convert msg buffer to nodeForge buffer: ByteBuffer is a \"binary-string backed buffer\", so let's make our buffer a binary string\n  - Convert resulting nodeForge buffer to buffer: it returns a binary string, turn that into a uint8array(buffer)\n\n*/\n\nconst { jwk2pub, jwk2priv } = require('./jwk2pem')\n\nfunction convertKey (key, pub, msg, handle) {\n  const fkey = pub ? jwk2pub(key) : jwk2priv(key)\n  const fmsg = Buffer.from(msg).toString('binary')\n  const fomsg = handle(fmsg, fkey)\n  return Buffer.from(fomsg, 'binary')\n}\n\nexports.encrypt = function (key, msg) {\n  return convertKey(key, true, msg, (msg, key) => key.encrypt(msg))\n}\n\nexports.decrypt = function (key, msg) {\n  return convertKey(key, false, msg, (msg, key) => key.decrypt(msg))\n}\n"]},"metadata":{},"sourceType":"script"}